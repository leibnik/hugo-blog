+++
mathjax = true
title = "走进科学之 3，5，7 取物游戏"
date = "2017-12-19"
tags = ["game", "math", "algorithm"]
categories = ["math"]
+++

## 前言
最近公司活动玩了一个叫 3，5，7 取物的博弈游戏，其规则是两位玩家轮流取物，每次取物只能在三堆物品中选择其中一堆并至少取走一个，可以直接一堆取完，所有堆取完游戏即结束并且最后取完的输。
这个游戏其实是一个叫 Nim 博弈游戏的一种变种玩法，Nim 游戏通常的玩法如下:

> The normal game is between two players and played with three heaps of any number of objects. The two players alternate taking any number of objects from any single one of the heaps. The goal is to be the last to take an object. [#wiki](https://en.wikipedia.org/wiki/Nim#Game_play_and_illustration)

通常 Nim 游戏的获胜目标是争取成为最后一个取完的玩家，如果反着来，最后一个取完的玩家判为输，则是 Nim 游戏的一种变形，一般称为 Anti-Nim。

据了解这个游戏源自中国，后由到美洲打工的华人外传，之所以称为 Nim 有个说法称是由粤语的“拈”音译而得，Nim 游戏后来也演化出多个版本的玩法，它的必胜策略直到 20 世纪初才由一个叫 [Charles L. Bouton](https://en.wikipedia.org/wiki/Charles_L._Bouton) 的数学家给出。论文地址：[Nim, A Game with a Complete Mathematical Theory](http://www.jstor.org/stable/1967631?origin=crossref&seq=1#page_scan_tab_contents)

## 分析
### Nim 的分析
先来分析下 Nim 游戏的规律(注意是先取完为胜的玩法)，以取石子为例，假定 w 为石子的总数(w >= 1)，这些石子被分为 n 堆(n >= 1)，局面状态以 ( $x_1$ , $x_2$, ...,$x_n$ ) 进行表示:

1. 当 n = 1 同时 w = 1 时，显然先取者胜
2. 当 n = 2 时，可以分为四种情况进行讨论

	
	**①** (1, 1) 状态，显然先手败

	**②** (1, $x$) 状态，其中 $x$ > 1，此时先手只需在 $x$ 中取走 $x$ - 1，即变为 (1, 1) 这种“安全局面”即可获胜

	**③** ($x$, $x$) 状态，其中 $x$ > 1，此时先手取后变为( $x_1$ , $x$)，后手总是能使局面转变为 ($x_1$, $x_1$)，若先手不服气，后手总能使局面往 **①** 情况发展，先手必败

	**④** ($x_1$, $x_2$) 状态， 其中 $x_1$ > 1 且 $x_2$ > 1，同时有 $x_1$ 不等于 $x_2$，此时先手必定能将局面转变为 **③** ，此时先手必胜
	

	先回想下异或操作的规则：

	```
	0 $\oplus$ 0 = 0
	0 $\oplus$ 1 = 1
	1 $\oplus$ 1 = 0

	注： $\oplus$ 为异或的数学符号
	```

	根据该规则我们知道，若 $x_1$ ≠ $x_2$ 时，$x_1$ $\oplus$ $x_2$ ≠ 0，若 $x_1$ = $x_2$ 时，$x_1$ $\oplus$ $x_2$ = 0
	
	当堆数为 2，总石子数目为 w ，两堆均为相等的数目的石子时，此时 $x_1$ = w / 2, $x_1$ $\oplus$ $x_1$ = 0，先手取了其中一堆的 $x_1$ - $x_2$ 个，局面变为 ($x_1$, $x_2$)，此时 $x_2$ $\oplus$ $x_1$ ≠ 0，在此基础上后手依旧能使局面变为 ($x_2$, $x_2$)，$x_2$ $\oplus$ $x_2$ = 0，若先手不服气，双方僵持直至前面说的 (1, 1) 的局面，因此先手必败。

	当堆数为 2，总石子数目为 w ，两堆为不相等的数目的石子时，局面状态为 ($x_1$, $x_2$) 其中 $x_1$ > $x_2$，此时 $x_2$ $\oplus$ $x_1$ ≠ 0，先手能使局面变为 ($x_2$, $x_2$)，$x_2$ $\oplus$ $x_2$ = 0，游戏进行下去先手必胜。

	针对以上 n = 2 时的两种情形的讨论可以发现，异或规则可以用于判断先手的胜负，我们可以得到这样的结论：**当 n = 2 时，对于 ($x_1$, $x_2$)，$x_1$ > 0 且 $x_2$ > 0 ，利用异或操作符我们可以判断出先手的胜负，此时若 $x_1$ $\oplus$ $x_2$ = 0 ，则先手输，反之 $x_1$ $\oplus$ $x_2$ ≠ 0 则先手胜。**

3. 当 n > 2 时，情况又变得更为复杂，不妨讨论以下几种情形

	
	**①** 所有堆均为 1 的情况，此时若 n 为偶数，显然先手败，若 n 为奇数时，先手胜，我们发现此情形下依旧能使用异或进行对先手的胜负进行判断，对于1 $\oplus$ 1 $\oplus$ ... $\oplus$ 1，当 1 的个数若为偶数则异或结果为 0，个数若为奇数时结果不为 0，符合 n = 2 时所得出的结论。
	
	**②** 所有堆中有且只有一个大于 1 的堆，即 (1, 1, 1,...,$x$)，若为 1 的堆数为偶数时，先手将 $x$ 的那堆直接拿完，后手必败，若为 1 的堆数为奇数时，先手仍可从 $x$ 那堆中拿走 $x$ - 1 个，使局面转变为所有的堆均为 1 且堆数为偶数，此情形下先手必胜。同理的，1 $\oplus$ 1 $\oplus$ ... $\oplus$ $x$ 在 $x$ > 1 时，值始终不为 0，同样可以以此判断先手的胜负。 
	
	**③** 再来考虑这种情形 ($x_1$, $x_1$, $x_2$)，其中 $x_1$ > 1，$x_2$ > 1 且 $x_1$ ≠ $x_2$，此时根据前面的结论得出 $x_1$ $\oplus$ $x_1$ $\oplus$ $x_2$ ≠ 0，先手必胜，事实上也是这样的，先手只需取光 $x_2$ 使局面变为 ($x_1$, $x_1$, 0)，即后手变为局面 ($x_1$, $x_1$) 的先手，必败无疑，所以对于($x_1$, $x_1$, $x_2$) 的情形，先手必胜。

	**④** 根据前面的讨论，对于 ($x_1$, $x_2$, $x_3$)，其中 $x_1$ > 1，$x_2$ > 1，$x_3$ > 1 且 $x_1$ ≠ $x_2$ ≠ $x_3$，先手应避免直接使局面变为($x$, $x$, $y$)，($x$，$y$, 0) 其中 $x$ > 0, $y$ > 0 且 $x$ ≠ $y$，而获胜的关键恰恰就是迫使对方把局面变为 ($x$, $x$, $y$) 或 ($x$，$y$, 0)，具体举几个例子：
	```
	对于 (1, 2, 3) 这样的局面，无论怎么拿，都会使局面转变为 ($x$, $x$, $y$)，($x$，$y$, 0) 其中 $x$ > 0, $y$ > 0 且 $x$ ≠ $y$，并且发现将各堆数进行异或运算后值为 0。
	```

	 | $2^2$| $2^1$|$2^0$ 
	---|---|---|---
	1|0|0|1
	2|0|1|0
	3|0|1|1
	xor|0|0|0

	```
	同样的对于 (3, 4, 7) 
	```

	 | $2^2$| $2^1$|$2^0$ 
	---|---|---|---
	3|0|1|1
	4|1|0|0
	7|1|1|1
	xor|0|0|0
	推导一番就会发现后手总能使先手下出 ($x$, $x$, $y$)，($x$，$y$, 0) 的局面

	那么(3, 5, 7)又是怎样呢

	 | $2^2$| $2^1$|$2^0$ 
	---|---|---|---
	3|0|1|1
	5|1|0|1
	7|1|1|1
	xor|0|0|1
	推导一番就会发现此次是先手总能逼迫后手下出 ($x$, $x$, $y$)，($x$，$y$, 0) 的局面

	多尝试几组 n = 3 的玩法，就会发现当 $x_1$ $\oplus$ $x_2$ $\oplus$ $x_3$ ≠ 0 时，先手始终有办法使自身处于安全的局面，而对方又不得不下出“坏手”，而当  $x_1$$\oplus$$x_2$$\oplus$$x_3$ = 0 时情况则反了过来。讲到这里就需要提一下博弈论中的必败态，所谓必败态，即`在对方使用最优策略时，无论做出什么决策都会导致失败的局面，其他的局面则称为非必败态。`

	必败态和非必败态有以下性质：

	>
	> 1、若面临末状态者为获胜则末状态为非必败态否则末状态为必败态。
	> 
    > 2、一个局面是非必败态的充要条件是该局面进行某种决策后会成为必败态。
    >
    > 3、一个局面是必败态的充要条件是该局面无论进行何种决策均会成为非必败态
	>

	依据前面的讨论，可以发现 $x_1$ $\oplus$ $x_2$ $\oplus$ $x_3$ = 0 即是 nim 游戏中的必败态，当玩家面对 $x_1$ $\oplus$ $x_2$ $\oplus$ $x_3$ = 0 的局面时，无论怎么取都会使 $x_1$ $\oplus$ $x_2$ $\oplus$ $x_3$ ≠ 0，而当玩家面对 $x_1$ $\oplus$ $x_2$ $\oplus$ $x_3$ ≠ 0 则总有办法使 $x_1$ $\oplus$ $x_2$ $\oplus$ $x_3$ = 0。

	继续推广到 n 堆的情况，同样的 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ = 0 是 nim 游戏中的必败态，当玩家面对 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ = 0 的局面时，无论怎么取都会使 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ ≠ 0，而当玩家面对 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ ≠ 0 则总有办法使 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ = 0。这里便可得出结论：**$x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ = 0  则先手输，否则先手胜**

	通过前面的讨论我们知道，**在 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ ≠ 0 时，先手若采取最优策略必胜，此时的必胜策略也是显而易见的，只要每次使 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ = 0 把必败态交给对方即可取胜。**

### Anti-Nim 的分析

Nim 游戏是最后取完的人获胜，而 Anti-Nim 则是最后取完的人输。

有了前面对 nim 游戏的分析，我们可以将 anti-nim 游戏简化为以下几种情形: 

1. 当 n 堆石子所有堆的石子的个数均为 1：

	① 当 n 为偶数时，为先手的非必败态

	② 当 n 为奇数时，为先手的必败态

2. 当 n 堆石子中有且仅有一个石子数目大于 1 的堆：

	① 当 n - 1 为偶数时，先手可将石子数目大于 1 的堆的石子取剩至 1 ，转变为 1.②,，先手胜；

	② 当 n - 1 为奇数时，先手直接将石子数目大于 1 的那堆取完，1.②，先手胜；

	因此此场景为先手的非必败态

3. 当 n 堆石子中存在两个以上石子数目大于 1 的堆，堆状态为 ($x_1$, $x_2$,..., $x_n$)：
	
	① 当 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ = 0 时，只可能向两种状态转变

	  	(a). n 堆石子中有且仅有一个石子数目大于 1 的堆

	  	(b). 依旧存在两个以上石子数目大于 1 的堆，但 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ ≠ 0

	  此时(a), (b) 两种状态对后手而言是非必败态，也就是说 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ = 0 时，先手必败

	② 当 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ ≠ 0 时，先手总有办法使局面转化为 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ = 0，此时对先手而言，$x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ ≠ 0 为非必败态，而后手遇到 3.① 的局面只能又把非必败态交给对方

结合以上几种情形可以得出结论: **当所有堆的石子数均为 1 且 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ 为 0 或 至少存在一个以上石子数目大于 1 的堆且 $x_1$ $\oplus$ $x_2$ $\oplus$ ... $\oplus$ $x_n$ 不为 0时，先手必胜**

## 定理及证明

**定理： 对于 Nim 游戏，当且仅当 nim-sum ≠ 0 时，先手有必胜策略。否则，后手有必胜策略。**

```
证明： 

注意到 nim-sum ($\oplus$) 满足加法中常见的结合律与交换律，同时还满足  x $\oplus$ x = 0。我们以 $x_1$,..., $x_n$ 表示移动前的状态，以 $y_1$,...,$y_n$ 为移动后的状态，设 s = $x_1$ $\oplus$...$\oplus$$x_n$ ，t = $y_1$ $\oplus$...$\oplus$$y_n$，当移动的堆为第 k 堆，我们有 $x_i$ = $y_i$ 且 i ≠ k，$x_k$ > $y_k$。根据异或的特性可得：

t = 0 $\oplus$ t
  = s $\oplus$ s $\oplus$ t
  = s $\oplus$ ($x_1$ $\oplus$ ... $\oplus$ $x_n$) $\oplus$ ($y_1$ $\oplus$ ... $\oplus$ $y_n$)
  = s $\oplus$ ($x_1$ $\oplus$ $y_1$) $\oplus$ ... $\oplus$ ($x_n$ $\oplus$ $y_n$)
  = s $\oplus$ 0 $\oplus$ ... $\oplus$ 0 $\oplus$ ($x_k$ $\oplus$ $y_k$) $\oplus$ 0 $\oplus$ ... $\oplus$ 0
  = s $\oplus$ $x_k$ $\oplus$ $y_k$

公式一： t = s $\oplus$ $x_k$ $\oplus$ $y_k$
```



**推论一: 对于 Nim 游戏，若 s = 0，无论如何取都将使 t ≠ 0 。**

```
证明： 

根据公式一，当 s = 0 时， t = $x_k$ $\oplus$ $y_k$ 又由异或的特性可得 $x_k$ $\oplus$ $y_k$ ≠ 0，因此 t ≠ 0 。
```


**推论二: 对于 Nim 游戏，若 s ≠ 0，总有方法使 t = 0 。**

```
证明：

设第 d 位为 s (以二进制表示) 最左边不为 0 的位，可以找到第 k 堆 $x_k$ (以二进制表示) 的第 d 位不为 0 。再使 $y_k$ = s $\oplus$ $x_k$，已知 $x_k$ > $y_k$ ，$x_k$ 与 $y_k$ 的二进制位从最左边至 d 位相同。将 d 位的 1 变为 0 ，d 位右侧余下的二进制位最高为 $2^d$ - 1。第一位玩家可以从第 k 堆中拿走 $x_k$ - $y_k$ 的物品，使得

t = s $\oplus$ $x_k$ $\oplus$ $y_k$
  = s $\oplus$ $x_k$ $\oplus$ (s $\oplus$ $x_k$)
  = 0
```



## 参考
[组合数学](https://book.douban.com/subject/10606626/) 1.7 节

[编程之美](https://book.douban.com/subject/3004255/)	1.12 节

[Nim, A Game with a Complete Mathematical Theory](http://www.jstor.org/stable/1967631?origin=crossref&seq=1#page_scan_tab_contents)

[wiki#Nim](https://en.wikipedia.org/wiki/Nim#Game_play_and_illustration)

## 值得一刷的题
[杭电oj：取(m堆)石子游戏](http://acm.hdu.edu.cn/showproblem.php?pid=2176)

[LeetCode: Nim Game](https://leetcode.com/problems/nim-game/)

[codewars 4ky 题目: Nim](https://www.codewars.com/kata/nim/train/javascript)
